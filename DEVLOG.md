# Sorolla SDK - Development Log (Agentic Hindsight)

> **Purpose**: Track validated learnings and insights for future AI agents
> **Format**: Reverse chronological (newest first)

---

## Recent Session Learnings

### 2026-02-09 - Firebase 13.7.0 Upgrade + EDM4U Gradle/Java Incompatibility

**Summary:** Upgraded Firebase UPM fork from 12.10.1 → 13.7.0. EDM4U Android resolver fails on first run due to Gradle/Java version mismatch.

**What Changed (Firebase fork):**
- Repo: `https://github.com/LaCreArthur/unity-firebase-app` tag `13.7.0`
- FirebaseApp, Analytics, Crashlytics, RemoteConfig binaries updated
- EDM4U updated 1.2.185 → 1.2.187
- New: `Firebase.Crashlytics.Editor.dll` (new in 13.7.0)
- Removed deprecated `fb_dynamic_links` and `fb_invites` icons
- `.gitattributes` cleaned up (added `*.srcaar`, `*.pdb`, `*.exe` LFS patterns)
- SdkRegistry: `FIREBASE_VERSION` → `"13.7.0"`, `EDM_VERSION` → `"1.2.187"`

**EDM4U Gradle/Java Bug — Root Cause Chain:**
```
EDM4U Android Resolve triggers
  → Generates Gradle project in Temp/PlayServicesResolverGradle/
    → gradle-wrapper.properties hardcodes Gradle 5.1.1 (embedded in Google.JarResolver.dll)
      → gradlew picks up system Java via JAVA_HOME or PATH
        → Gradle 5.1.1 uses Groovy 2.5.x which requires Java 8-12
          → Java 17+ → NoClassDefFoundError: org.codehaus.groovy.vmplugin.v7.Java7
```

**Key facts:**
- Gradle 5.1.1 supports Java 8-12 only
- Gradle 7.3+ supports Java 17, Gradle 8.5+ supports Java 21
- The Gradle version is **hardcoded inside Google.JarResolver.dll** — cannot be patched via text files
- System Java (Homebrew OpenJDK 21) or Unity 6 bundled JDK (17+) both trigger this
- This is a **Google/EDM4U upstream bug** — they never updated for Java 17+

**What actually happens (validated 2026-02-09):**
1. First run: EDM4U tries bundled Gradle 5.1.1 → fails with Java 21
2. Second run (restart Unity): EDM4U falls back to **Gradle template mode**
3. Instead of downloading .aar files, it writes dependency declarations into `Assets/Plugins/Android/mainTemplate.gradle`
4. Actual Maven downloads happen at Android build time via Unity's own Gradle (which is Java-compatible)
5. This means dependencies resolve at build time, not in Editor — Editor uses the x86_64 binaries from the UPM packages

**Result:** The first-run Gradle error is cosmetic — EDM4U auto-recovers on restart by switching strategy. No manual fix needed.

**Files generated by Gradle template mode:**
- `Assets/Plugins/Android/mainTemplate.gradle` — dependency declarations
- `Assets/Plugins/Android/gradleTemplate.properties`
- `Assets/Plugins/Android/settingsTemplate.gradle`

**Reproduction:**
1. Import Firebase 13.7.0 packages into a Unity 6 project
2. EDM4U auto-resolves Android dependencies → Gradle 5.1.1 crashes with Java7 NoClassDefFoundError
3. Restart Unity → EDM4U switches to Gradle template mode → succeeds

**iOS minimum deployment target:** Firebase 13.x requires iOS 15.0+

### 2026-01-26 - Facebook SDK Now Core (Always Installed)

**Summary:** Changed Facebook SDK from `PrototypeOnly` to `Core` requirement.

**What Changed:**
- `SdkRegistry.cs`: Facebook requirement `PrototypeOnly` → `Core`
- `Palette.cs`: Facebook initializes in ALL modes (removed `if (isPrototype)` check)
- `AndroidManifestSanitizer.cs`: Removed Facebook from orphan cleanup patterns (no longer uninstalled)
- Updated mode documentation across README, CLAUDE.md, architecture.md, SorollaConfig, SorollaSettings

**Rationale:**
- Facebook provides valuable attribution data in both modes
- Simplifies codebase (fewer conditional paths)
- No downside to having Facebook always on

**Mode Summary (Post-Change):**
| Mode | Core SDKs |
|------|-----------|
| Prototype | GameAnalytics, Facebook, Firebase |
| Full | GameAnalytics, Facebook, MAX, Adjust, Firebase |

---

### 2026-01-21 - DontDestroyOnLoad Fix & KISS Reminder

**Problem Solved:** hungrysnake UIManager assertion failure during initialization

**Solution Implemented:**
1. Triple-defense `MakePersistent()` in SorollaBootstrapper
2. `[DefaultExecutionOrder(-1000)]` attribute for timing guarantee

**Key Learning:** Initially created 105-line auto-setup Editor script before realizing Unity's built-in `[DefaultExecutionOrder]` attribute was sufficient. **Overengineered due to defensive "what if" thinking instead of KISS.**

**Commits:**
- b670230: Added MakePersistent() + auto-setup script
- 635c97d: Removed auto-setup script (overengineered)
- 1c77409: Updated DEVLOG with DefaultExecutionOrder

**Takeaway:** Always ask "what's the simplest solution?" before coding. Unity built-ins exist for a reason.

---

## Quick Reference: Critical Learnings

These are the most important validated learnings. Read these first.

### DontDestroyOnLoad Conflicts (Unity 6+)
```
Problem: Assertion failure when client MonoSingletons call DontDestroyOnLoad during BeforeSceneLoad
Solution: Triple-defense in SorollaBootstrapper.MakePersistent()
  1. Check HideFlags.DontSave before calling DontDestroyOnLoad
  2. Verify scene.IsValid() && scene.isLoaded
  3. Try-catch as final safety net
  4. [DefaultExecutionOrder(-1000)] to initialize before client code
Result: SDK works at all costs, no silent failures, no user intervention
```

### Unity Assembly Definitions (asmdef)
```
versionDefines: PER-ASSEMBLY only (NOT project-wide!)
defineConstraints: Required to prevent compilation when SDK missing
Both are needed together for optional SDK assemblies
```

### IL2CPP Code Stripping (Packages)
```
link.xml: NOT auto-included from UPM packages - must be in Assets/
[AlwaysLinkAssembly]: Forces linker to PROCESS (not preserve)
[Preserve]: Actually marks code as roots
Both needed for [RuntimeInitializeOnLoadMethod] in packages
```

### The Correct asmdef Pattern
```json
{
    "defineConstraints": ["APPLOVIN_MAX_INSTALLED"],
    "versionDefines": [
        {
            "name": "com.applovin.mediation.ads",
            "expression": "",
            "define": "APPLOVIN_MAX_INSTALLED"
        }
    ]
}
```

### EDM4U Gradle Compatibility (Unity 6+)
```
EDM4U bundles Gradle 5.1.1 → incompatible with Java 17+ (Unity 6 default)
First resolution may fail, but works after selecting mode and re-resolving
Auto-config runs too late to catch initial EDM4U resolution
```

### MAX SDK Key Location
```
SDK key is in AppLovinSettings (Integration Manager), NOT SorollaConfig
MaxSdk.SetSdkKey() is deprecated - SDK reads from settings automatically
Use reflection to access: Type.GetType("AppLovinSettings, MaxSdk.Scripts.IntegrationManager.Editor")
```

### Namespace Translation (Legacy References)
```
When reading older docs/context, mentally translate:
SorollaSDK. → Palette.
using Sorolla; → using Sorolla.Palette;
SorollaSDK.cs → Palette.cs
```

### Firebase Git Package Installation
```
Multiple packages from same git repo cause "Directory not empty" errors
UPM clones same repo multiple times simultaneously → race condition
Solution: Clear Library/PackageCache/.tmp* and com.google.firebase* before install
```

---

## 2026-01-20: Firebase Cache Cleanup Fix

**Summary**: Added automatic cache cleanup before Firebase installation to prevent "Directory not empty" errors.

**The Problem**:
Firebase uses 4 packages from the same git repo with different `?path=` parameters:
```json
"com.google.firebase.analytics": "...unity-firebase-app.git?path=FirebaseAnalytics#12.10.1"
"com.google.firebase.app": "...unity-firebase-app.git?path=FirebaseApp#12.10.1"
```

Unity Package Manager clones the same repo multiple times simultaneously, creating race conditions:
- Temporary directories conflict (`Library/PackageCache/.tmp-*`)
- Incomplete checkouts leave stale directories blocking subsequent installations

This manifests as `ENOTEMPTY: directory not empty` errors (known Unity 6 bug).

**Solution**:
Clear stale cache before Firebase installation in `SdkInstaller.cs`:
- `.tmp*` directories (failed checkouts)
- `com.google.firebase*` directories (forces fresh clone)

Non-fatal on failure - installation continues even if cleanup fails.

**Documentation Sources**:
- [Unity Manual: Git dependencies](https://docs.unity3d.com/6000.3/Documentation/Manual/upm-git.html)
- [Unity Forum: ENOTEMPTY error](https://discussions.unity.com/t/error-while-resolving-packages-enoempty-and-einval/942440)

**Files Changed**:
- `Editor/Sdk/SdkInstaller.cs`: Added `ClearFirebasePackageCache()`

---

## 2026-01-13: v3.1.0 - Firebase Mandatory

**Summary**: Made Firebase required in all modes (Prototype + Full) with zero-friction upgrade path.

**Changes**:
- `SdkRegistry.cs`: Changed all 4 Firebase packages from `Optional` to `Core`
- `SorollaSetup.cs`: Bumped SetupVersion to v7, added `FirebaseMigrationKey` for one-time popup
- `MigrationPopup.cs`: New EditorWindow guides users through Firebase setup
- `package.json`: Version 3.0.0 → 3.1.0

**Follow-up fix**: Removed stale "optional" Firebase references from:
- `SorollaWindow.cs`: UI now shows red ✗ when Firebase not installed
- `README.md`: Mode tables updated
- `BuildValidator.cs`: "No Firebase" now shows as Warning
- `SorollaConfig.cs`: Header attributes no longer say "(Optional)"
- `CLAUDE.md`: Mode system table updated

**Learnings**:
- SetupVersion bump triggers full setup for existing users (installs new Core packages)
- Separate migration key needed for one-time UI (separate from setup key)
- EditorWindow.ShowUtility() creates modal-like behavior without blocking
- When changing requirement levels, grep for "optional" mentions across entire codebase

---

## 2026-01-09: SDK Simplification - Complete

**Summary**: Completed all 11 tasks in the simplification plan.

**Bug Fixes**:
- `Palette.cs:202`: `s_config` → `Config` (undefined variable)
- `SorollaTestingTools.cs:18`: `v3` → `v6` (stale EditorPrefs key)

**Dead Code Removed**:
- `SorollaConfig.IsValid()` - no callers
- `SdkConfigDetector.GetCrashlyticsStatus()` - no callers
- `SdkConfigDetector.GetRemoteConfigStatus()` - no callers

**Deduplication**:
- `SorollaWindow.cs`: Added `SdkRowData` struct + `DrawSdkRow()` helper
- `SdkInstaller.cs`: Extracted `EnsureMaxRegistry()` for MAX registry setup
- `MaxSettingsSanitizer.cs`: Cached `AppLovinSettings` Type lookup

**Files Merged/Deleted**:
- `SorollaMode.cs` → merged into `SorollaSettings.cs` (deleted)
- `BuildValidationWindow.cs` → merged into `SorollaWindow.cs` (deleted)
- `FirebaseCoreManager.cs` → merged into `FirebaseAdapter.cs` (deleted)

**Cleanup**:
- Trimmed verbose comments in 3 AssemblyInfo.cs files

---

## 2026-01-08: Remove deprecated MaxSdk.SetSdkKey()

**Summary**: SDK key now lives in AppLovinSettings (Integration Manager), not SorollaConfig.

**Changes**:
- Removed `maxSdkKey` from `SorollaConfig.cs`
- Removed `sdkKey` parameter from `MaxAdapter.Initialize()` and `IMaxAdapter`
- Added SDK key helpers to `MaxSettingsSanitizer.cs`: `GetSdkKey()`, `IsSdkKeyConfigured()`
- Added SDK key validation to `BuildValidator.CheckMaxSettings()`

**Learnings**:
- `MaxSdk.SetSdkKey()` deprecated - SDK reads from `AppLovinSettings.Instance.SdkKey`
- `AppLovinSettings` is unnamespaced, requires reflection to access
- Must search all loaded assemblies as fallback (assembly name varies by MAX SDK version)
- Unity meta files MUST be committed with new .cs files - missing meta = compile errors

---

## 2026-01-06: Namespace Refactor & Documentation Consolidation

**Summary**:
Major internal documentation update reflecting v2.3.3 changes.

**Key Changes**:
1. **Namespace refactored**: `SorollaSDK` class → `Palette` class, `using Sorolla;` → `using Sorolla.Palette;`
2. **Facebook SDK**: Required for prototype mode UA campaigns
3. **GDPR/UMP complete**: Full consent flow via MAX SDK (CmpService)
4. **Debug UI moved**: Now a UPM sample (`Samples~/DebugUI`)

**Documentation Consolidated**:
- Removed `plan.md` (outdated task tracking)
- Removed `max-mediation-plan.md` (session-specific, paused)
- Updated all internal docs to use correct `Palette` namespace
- Updated feature matrices to reflect completed GDPR/UMP
- ADRs moved to `product-roadmap.md`

**Files Changed**:
- All internal documentation files updated
- Version references updated to 2.3.3

---

## 2025-12-29: EDM4U Gradle Java 17+ (Partial Fix)

**Summary**:
Auto-configure EDM4U to use Unity's Gradle templates. Note: Initial resolution may still fail.

**The Problem**:
On Unity 6+ (Java 17+ default), EDM4U's first Android resolution may fail:
```
java.lang.NoClassDefFoundError: Could not initialize class org.codehaus.groovy.vmplugin.v7.Java7
```

**Root Cause**:
EDM4U bundles Gradle 5.1.1 which doesn't support Java 17+. EDM4U triggers resolution immediately on import, before our setup code runs.

**Partial Solution**:
Auto-configure EDM4U via reflection in `SorollaSetup.cs`:
```csharp
GooglePlayServices.SettingsDialog.PatchMainTemplateGradle = true;
GooglePlayServices.SettingsDialog.PatchPropertiesTemplateGradle = true;
GooglePlayServices.SettingsDialog.PatchSettingsTemplateGradle = true;
```

**Actual Behavior**:
1. First import → EDM4U resolves before setup → may fail with Java error
2. User selects mode → triggers re-resolution → works (settings now applied)
3. Acceptable UX - error is transient and self-resolves

---

## 2025-12-29: Assembly Definition Pattern Validated

**Summary**:
After multiple iterations and a broken release (v2.3.2), the correct pattern for optional SDK assemblies is now validated.

**The Problem**:
Fresh imports without SDKs installed caused CS0246 errors:
```
error CS0246: The type or namespace name 'Firebase' could not be found
```

**Root Cause**:
Unity compiles C# files **before** checking if referenced assemblies exist. Without `defineConstraints`, Unity attempts to compile implementation files even when the SDK isn't installed.

**The Solution**:
Each implementation asmdef needs BOTH:
1. `versionDefines` - detects package presence, sets symbol (per-assembly only!)
2. `defineConstraints` - prevents compilation if symbol not set

**Key Documentation Finding**:
> "Symbols defined in the Assembly Definition are only in scope for the scripts in the assembly created for that definition."
> — Unity Manual: Conditionally including assemblies

**Hindsight Insights**:
- `versionDefines` are **PER-ASSEMBLY**, not project-wide
- "Assembly references as constraints" does NOT work - that was a bad theory
- Always test fresh imports WITHOUT optional SDKs to verify compilation

---

## 2025-12-26: IL2CPP Stripping Protection (Unity 6)

**Summary**:
Implemented code preservation strategy for packages using `[RuntimeInitializeOnLoadMethod]`.

**Key Findings from Unity Docs**:

1. **link.xml in packages**: NOT auto-included by Unity. Must be in `Assets/` folder.
2. **[AlwaysLinkAssembly]**: Forces linker to **process** assembly, but doesn't preserve it.
3. **[Preserve]**: Actually marks code as roots and prevents stripping.

**Implementation**:
```csharp
// AssemblyInfo.cs in each impl assembly
[assembly: AlwaysLinkAssembly]

// On implementation class
[Preserve]
internal class MaxAdapterImpl : IMaxAdapter
{
    [RuntimeInitializeOnLoadMethod(RuntimeInitializeLoadType.BeforeSceneLoad)]
    [Preserve]
    private static void Register() { ... }
}
```

**Protection Strategy (3 layers)**:
1. `[assembly: AlwaysLinkAssembly]` - Forces linker to process assembly
2. `[Preserve]` attributes - Marks specific code as roots
3. `link.xml` (auto-copied to Assets/) - Fallback manual override

**UMP/GDPR**: MAX SDK handles UMP automatically via `CmpService`. Tested working on Android.

**Files Created**:
- `Runtime/Adapters/MAX/AssemblyInfo.cs`
- `Runtime/Adapters/Adjust/AssemblyInfo.cs`
- `Runtime/Adapters/Firebase/AssemblyInfo.cs`

---

## 2025-12-24: Stub + Implementation Pattern (v2.3.0)

**Summary**:
Refactored optional SDK adapters to handle Unity's assembly resolution order.

**The Problem**:
Unity resolves assembly references BEFORE evaluating `#if` preprocessor blocks:
```csharp
#if FIREBASE_INSTALLED
using Firebase;  // Unity tries to resolve this even if false!
#endif
```

**The Solution**: Stub + Implementation pattern with separate assemblies.

**Structure**:
```
Adapters/
├── Sorolla.Adapters.asmdef      (no external refs - always compiles)
├── MaxAdapter.cs                 (stub → delegates to impl)
├── MAX/
│   ├── Sorolla.Adapters.MAX.asmdef  (defineConstraints + versionDefines)
│   ├── AssemblyInfo.cs              ([AlwaysLinkAssembly])
│   └── MaxAdapterImpl.cs            (registers at runtime)
```

**How It Works**:
1. SDK not installed → `versionDefines` not met → `defineConstraints` fail → assembly skipped
2. SDK installed → assembly compiles → `[RuntimeInitializeOnLoadMethod]` registers impl
3. At runtime → stub delegates to impl if registered

**Hindsight Insights**:
- Use Stub + Impl pattern for all optional SDK adapters
- `defineConstraints` can use `||` for OR logic
- Interface must be `internal` so users only see public static class
- Events need forwarding from impl to stub

---

## 2025-12-18: Pain Points & UMP Priority

**Summary**:
Analyzed developer pain points and prioritized GDPR/UMP as critical gap.

**Key Findings**:
- Google UMP deadline was Jan 2024
- MAX SDK automates UMP via CmpService (no manual integration needed)
- Firebase 12.x still compatible, 13.x available

**UMP Status**: Complete (MAX handles automatically)

---

## 2025-12-01: Firebase Integration (v2.1.0)

**Key Learnings**:
- Firebase requires `CheckAndFixDependenciesAsync` before use
- Remote config needs explicit `FetchAndActivate` call
- Config files MUST match bundle ID exactly
- Fallback chain: Firebase → GA → default

---

## 2025-11-26: SDK Installation (v2.0.1)

**Key Learnings**:
- Direct manifest.json editing more reliable than PackageManager API
- Add scoped registries before dependencies
- Installation order: EDM → GA → platform SDKs
- `SdkRegistry.cs` is single source of truth for versions

---

## 2025-11-10: Initial Release (v1.0.0)

**Key Learnings**:
- ATT must happen before SDK init for best ad fill
- Facebook requires App ID AND Client Token
- MAX SDK key is account-level, ad units are app-level
- Prototype mode = no attribution, Full mode = production

---

## Agent Instructions

**When to add entries**:
- After validating a fix that corrects previous mistakes
- When discovering non-obvious Unity behavior
- After fixing bugs (document root cause)

**Entry guidelines**:
- Only add VALIDATED learnings (tested, confirmed working)
- Focus on "what future me needs to know"
- Include official documentation sources when possible
- Delete/update entries that are proven wrong
